<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lane Overlay</title>

    <!-- THEME: Change this line to switch themes -->
    <link href="themes/mario-theme.css" rel="stylesheet">
    <!-- Alternative: <link href="themes/default-theme.css" rel="stylesheet"> -->

    <style>
        /* ==================== */
        /* STRUCTURAL CSS ONLY */
        /* (Layout, positioning) */
        /* ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: transparent;
            height: 100vh;
            overflow: hidden;
        }

        .lanes-container {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100vh;
            padding: 20px 0;
        }

        .lane-box {
            position: relative;
            height: calc((100vh - 40px) / 8 - 8px);
            margin: 4px 0;
            overflow: hidden;
        }

        .lane-content {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: calc(100% - 70px);
            display: flex;
            align-items: center;
            padding: 0 20px;
            transform: scaleX(0);
            transform-origin: right center;
            opacity: 0;
            transition: none;
        }

        .lane-info {
            display: flex;
            flex: 1;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
        }

        .place-indicator {
            font-weight: bold;
            min-width: 80px;
            text-align: center;
            margin-right: 15px;
        }

        .swimmer-name {
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .final-time {
            font-variant-numeric: tabular-nums;
            min-width: 200px;
            text-align: right;
        }

        .split-content {
            position: absolute;
            right: 70px;
            top: 0;
            height: 100%;
            display: flex;
            align-items: center;
            padding: 0 20px;
            transform: scaleX(0);
            transform-origin: right center;
            opacity: 0;
        }

        .split-time {
            font-variant-numeric: tabular-nums;
        }

        /* Pre-race lineup display */
        .lineup-content {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: calc(100% - 70px);
            display: flex;
            align-items: center;
            padding: 0 20px;
            transform: scaleX(0);
            transform-origin: right center;
            opacity: 0;
        }

        .lineup-info {
            display: flex;
            flex: 1;
            align-items: center;
            padding: 0 10px;
        }

        .lineup-lane {
            display: none;
        }

        .lineup-name {
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-right: 20px;
        }

        .lineup-team {
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Persistent lane number indicator */
        .lane-indicator {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 10;
        }

        /* Placeholder styling */
        .placeholder-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .placeholder-container.hidden {
            display: none;
        }

        .placeholder-lane {
            width: 100%;
            max-width: 400px;
            margin: 4px 0;
            padding: 15px 20px;
            opacity: 0.6;
        }

        .placeholder-text {
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        /* Mario brick explosion */
        .lane-indicator.brick-explode {
            animation: brickExplode 0.4s ease-out forwards;
        }

        @keyframes brickExplode {
            0% { transform: translateY(-50%) scale(1); opacity: 1; }
            30% { transform: translateY(-50%) scale(1.3); opacity: 1; }
            100% { transform: translateY(-50%) scale(0); opacity: 0; }
        }

        .brick-fragment {
            position: fixed;
            width: 10px;
            height: 10px;
            border-radius: 2px;
            pointer-events: none;
            z-index: 100;
            animation: fragmentFly 0.6s ease-out forwards;
        }

        @keyframes fragmentFly {
            0% { opacity: 1; transform: translate(0, 0) rotate(0deg); }
            100% { opacity: 0; transform: translate(var(--fx), var(--fy)) rotate(720deg); }
        }
    </style>
</head>
<body>
    <!-- Placeholder shown until first data received -->
    <div class="placeholder-container" id="placeholder">
        <div class="placeholder-lane lineup-content visible">
            <span class="placeholder-text">Waiting for data...</span>
        </div>
        <div class="placeholder-lane lineup-content visible">
            <span class="placeholder-text">Lane overlay ready</span>
        </div>
    </div>

    <div class="lanes-container">
        <div class="lane-box" id="lane-8">
            <div class="lane-indicator">8</div>
            <div class="lineup-content" id="lineupContent-8">
                <div class="lineup-lane" id="lineupLane-8"></div>
                <div class="lineup-info">
                    <span class="lineup-name" id="lineupName-8"></span>
                    <span class="lineup-team" id="lineupTeam-8"></span>
                </div>
            </div>
            <div class="lane-content" id="laneContent-8">
                <div class="place-indicator" id="place-8"></div>
                <div class="lane-info">
                    <span class="swimmer-name" id="swimmerName-8"></span>
                    <span class="final-time" id="finalTime-8"></span>
                </div>
            </div>
            <div class="split-content" id="splitContent-8">
                <span class="split-time" id="splitTime-8"></span>
            </div>
        </div>
        <div class="lane-box" id="lane-7">
            <div class="lane-indicator">7</div>
            <div class="lineup-content" id="lineupContent-7">
                <div class="lineup-lane" id="lineupLane-7"></div>
                <div class="lineup-info">
                    <span class="lineup-name" id="lineupName-7"></span>
                    <span class="lineup-team" id="lineupTeam-7"></span>
                </div>
            </div>
            <div class="lane-content" id="laneContent-7">
                <div class="place-indicator" id="place-7"></div>
                <div class="lane-info">
                    <span class="swimmer-name" id="swimmerName-7"></span>
                    <span class="final-time" id="finalTime-7"></span>
                </div>
            </div>
            <div class="split-content" id="splitContent-7">
                <span class="split-time" id="splitTime-7"></span>
            </div>
        </div>
        <div class="lane-box" id="lane-6">
            <div class="lane-indicator">6</div>
            <div class="lineup-content" id="lineupContent-6">
                <div class="lineup-lane" id="lineupLane-6"></div>
                <div class="lineup-info">
                    <span class="lineup-name" id="lineupName-6"></span>
                    <span class="lineup-team" id="lineupTeam-6"></span>
                </div>
            </div>
            <div class="lane-content" id="laneContent-6">
                <div class="place-indicator" id="place-6"></div>
                <div class="lane-info">
                    <span class="swimmer-name" id="swimmerName-6"></span>
                    <span class="final-time" id="finalTime-6"></span>
                </div>
            </div>
            <div class="split-content" id="splitContent-6">
                <span class="split-time" id="splitTime-6"></span>
            </div>
        </div>
        <div class="lane-box" id="lane-5">
            <div class="lane-indicator">5</div>
            <div class="lineup-content" id="lineupContent-5">
                <div class="lineup-lane" id="lineupLane-5"></div>
                <div class="lineup-info">
                    <span class="lineup-name" id="lineupName-5"></span>
                    <span class="lineup-team" id="lineupTeam-5"></span>
                </div>
            </div>
            <div class="lane-content" id="laneContent-5">
                <div class="place-indicator" id="place-5"></div>
                <div class="lane-info">
                    <span class="swimmer-name" id="swimmerName-5"></span>
                    <span class="final-time" id="finalTime-5"></span>
                </div>
            </div>
            <div class="split-content" id="splitContent-5">
                <span class="split-time" id="splitTime-5"></span>
            </div>
        </div>
        <div class="lane-box" id="lane-4">
            <div class="lane-indicator">4</div>
            <div class="lineup-content" id="lineupContent-4">
                <div class="lineup-lane" id="lineupLane-4"></div>
                <div class="lineup-info">
                    <span class="lineup-name" id="lineupName-4"></span>
                    <span class="lineup-team" id="lineupTeam-4"></span>
                </div>
            </div>
            <div class="lane-content" id="laneContent-4">
                <div class="place-indicator" id="place-4"></div>
                <div class="lane-info">
                    <span class="swimmer-name" id="swimmerName-4"></span>
                    <span class="final-time" id="finalTime-4"></span>
                </div>
            </div>
            <div class="split-content" id="splitContent-4">
                <span class="split-time" id="splitTime-4"></span>
            </div>
        </div>
        <div class="lane-box" id="lane-3">
            <div class="lane-indicator">3</div>
            <div class="lineup-content" id="lineupContent-3">
                <div class="lineup-lane" id="lineupLane-3"></div>
                <div class="lineup-info">
                    <span class="lineup-name" id="lineupName-3"></span>
                    <span class="lineup-team" id="lineupTeam-3"></span>
                </div>
            </div>
            <div class="lane-content" id="laneContent-3">
                <div class="place-indicator" id="place-3"></div>
                <div class="lane-info">
                    <span class="swimmer-name" id="swimmerName-3"></span>
                    <span class="final-time" id="finalTime-3"></span>
                </div>
            </div>
            <div class="split-content" id="splitContent-3">
                <span class="split-time" id="splitTime-3"></span>
            </div>
        </div>
        <div class="lane-box" id="lane-2">
            <div class="lane-indicator">2</div>
            <div class="lineup-content" id="lineupContent-2">
                <div class="lineup-lane" id="lineupLane-2"></div>
                <div class="lineup-info">
                    <span class="lineup-name" id="lineupName-2"></span>
                    <span class="lineup-team" id="lineupTeam-2"></span>
                </div>
            </div>
            <div class="lane-content" id="laneContent-2">
                <div class="place-indicator" id="place-2"></div>
                <div class="lane-info">
                    <span class="swimmer-name" id="swimmerName-2"></span>
                    <span class="final-time" id="finalTime-2"></span>
                </div>
            </div>
            <div class="split-content" id="splitContent-2">
                <span class="split-time" id="splitTime-2"></span>
            </div>
        </div>
        <div class="lane-box" id="lane-1">
            <div class="lane-indicator">1</div>
            <div class="lineup-content" id="lineupContent-1">
                <div class="lineup-lane" id="lineupLane-1"></div>
                <div class="lineup-info">
                    <span class="lineup-name" id="lineupName-1"></span>
                    <span class="lineup-team" id="lineupTeam-1"></span>
                </div>
            </div>
            <div class="lane-content" id="laneContent-1">
                <div class="place-indicator" id="place-1"></div>
                <div class="lane-info">
                    <span class="swimmer-name" id="swimmerName-1"></span>
                    <span class="final-time" id="finalTime-1"></span>
                </div>
            </div>
            <div class="split-content" id="splitContent-1">
                <span class="split-time" id="splitTime-1"></span>
            </div>
        </div>
    </div>

    <script id="swimmingScript" numberOfLanes="8">
        const NUM_LANES = 8;
        const SPLIT_DISPLAY_PERCENT = 0.4;

        let laneVisibility = new Array(NUM_LANES).fill(false);
        let splitVisibility = new Array(NUM_LANES).fill(false);
        let lineupVisibility = new Array(NUM_LANES).fill(false);
        let splitTimeouts = new Array(NUM_LANES).fill(null);
        let lastSplitValue = new Array(NUM_LANES).fill(null);
        let lastScoreboardState = 0;
        let raceInProgress = false;
        let raceStartTime = 0;
        const FINAL_TIME_GUARD_MS = 10000; // Suppress finals for 10s after race starts
        let firstMessageReceived = false;
        let laneIndicatorHidden = new Array(NUM_LANES).fill(false);

        function explodeLaneIndicator(laneNum) {
            const el = document.querySelector(`#lane-${laneNum} .lane-indicator`);
            if (!el || laneIndicatorHidden[laneNum - 1]) return;
            laneIndicatorHidden[laneNum - 1] = true;

            const rect = el.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;

            // Spawn brick fragments
            const colors = ['#FBD000', '#ff8800', '#c49800', '#ffe040'];
            for (let p = 0; p < 12; p++) {
                const frag = document.createElement('div');
                frag.className = 'brick-fragment';
                const angle = (Math.PI * 2 * p) / 12 + (Math.random() - 0.5) * 0.5;
                const dist = 30 + Math.random() * 50;
                frag.style.left = cx + 'px';
                frag.style.top = cy + 'px';
                frag.style.background = colors[p % colors.length];
                frag.style.setProperty('--fx', Math.cos(angle) * dist + 'px');
                frag.style.setProperty('--fy', (Math.sin(angle) * dist - 30) + 'px');
                document.body.appendChild(frag);
                setTimeout(() => frag.remove(), 600);
            }

            el.classList.add('brick-explode');
            setTimeout(() => { el.style.visibility = 'hidden'; }, 400);
        }

        function restoreLaneIndicator(laneNum) {
            const el = document.querySelector(`#lane-${laneNum} .lane-indicator`);
            if (!el || !laneIndicatorHidden[laneNum - 1]) return;
            laneIndicatorHidden[laneNum - 1] = false;
            el.classList.remove('brick-explode');
            el.style.visibility = '';
        }

        const channel = new BroadcastChannel('swimnerd-scoreboard');
        channel.onmessage = function(e) {
            processLaneData(e.data);
        };

        let client = null;
        function connectWebSocket() {
            try {
                client = new WebSocket("ws://localhost:8080/");
                client.onerror = () => console.log('WebSocket Connection Error');
                client.onopen = () => console.log('WebSocket Client Connected');
                client.onclose = () => {
                    console.log('WebSocket Client Closed');
                    setTimeout(connectWebSocket, 3000);
                };
                client.onmessage = (e) => processLaneData(JSON.parse(e.data));
            } catch (e) {
                console.log('WebSocket not available');
            }
        }
        connectWebSocket();

        function resetAllLanes() {
            for (let laneCounter = 0; laneCounter < NUM_LANES; laneCounter++) {
                const laneNum = laneCounter + 1;
                const laneContent = document.getElementById(`laneContent-${laneNum}`);
                const splitContent = document.getElementById(`splitContent-${laneNum}`);
                const lineupContent = document.getElementById(`lineupContent-${laneNum}`);
                const swimmerName = document.getElementById(`swimmerName-${laneNum}`);
                const finalTime = document.getElementById(`finalTime-${laneNum}`);
                const placeIndicator = document.getElementById(`place-${laneNum}`);
                const splitTime = document.getElementById(`splitTime-${laneNum}`);
                const lineupLane = document.getElementById(`lineupLane-${laneNum}`);
                const lineupName = document.getElementById(`lineupName-${laneNum}`);
                const lineupTeam = document.getElementById(`lineupTeam-${laneNum}`);

                // Hide and clear lane content
                laneContent.classList.remove('visible', 'first-place', 'second-place', 'third-place');
                laneContent.classList.add('hiding');
                laneVisibility[laneCounter] = false;
                swimmerName.textContent = '';
                finalTime.textContent = '';
                placeIndicator.textContent = '';

                // Hide and clear split content
                splitContent.classList.remove('visible');
                splitContent.classList.add('hiding');
                splitVisibility[laneCounter] = false;
                splitTime.textContent = '';
                if (splitTimeouts[laneCounter]) {
                    clearTimeout(splitTimeouts[laneCounter]);
                    splitTimeouts[laneCounter] = null;
                }

                // Hide and clear lineup content
                lineupContent.classList.remove('visible');
                lineupContent.classList.add('hiding');
                lineupVisibility[laneCounter] = false;
                lineupLane.textContent = '';
                lineupName.textContent = '';
                lineupTeam.textContent = '';

                lastSplitValue[laneCounter] = null;
            }
            raceInProgress = false;
        }

        function processLaneData(jsonData) {
            // Hide placeholder on first message
            if (!firstMessageReceived) {
                firstMessageReceived = true;
                document.getElementById('placeholder').classList.add('hidden');
            }

            const scoreboardState = jsonData.swimming.ScoreboardCurrentState || 0;

            // Detect transition to Running (state 3) — new race started
            if (scoreboardState === 3 && lastScoreboardState !== 3) {
                resetAllLanes();
                raceInProgress = true;
                raceStartTime = Date.now();
            }

            // Detect transition away from Running — race ended
            if (scoreboardState !== 3 && lastScoreboardState === 3) {
                raceInProgress = false;
            }

            lastScoreboardState = scoreboardState;

            // Show lineup when not in race
            const showLineup = !raceInProgress;

            for (let laneCounter = 0; laneCounter < NUM_LANES; laneCounter++) {
                const laneNum = laneCounter + 1;
                const laneData = jsonData.swimming.LaneAthleteTeam[laneCounter];
                const laneContent = document.getElementById(`laneContent-${laneNum}`);
                const swimmerName = document.getElementById(`swimmerName-${laneNum}`);
                const finalTime = document.getElementById(`finalTime-${laneNum}`);
                const placeIndicator = document.getElementById(`place-${laneNum}`);
                const splitContent = document.getElementById(`splitContent-${laneNum}`);
                const splitTime = document.getElementById(`splitTime-${laneNum}`);
                const lineupContent = document.getElementById(`lineupContent-${laneNum}`);
                const lineupLane = document.getElementById(`lineupLane-${laneNum}`);
                const lineupName = document.getElementById(`lineupName-${laneNum}`);
                const lineupTeam = document.getElementById(`lineupTeam-${laneNum}`);

                const hasData = laneData.LaneNumber.trim() !== "";
                const hasFinalTime = laneData.FinalTime && laneData.FinalTime.trim() !== "";
                const hasPlace = laneData.Place && laneData.Place.trim() !== "" && laneData.Place.trim() !== " ";
                const hasSplitTime = laneData.SplitTime && laneData.SplitTime.trim() !== "" && laneData.SplitTime.trim() !== ".";
                const pastGuard = (Date.now() - raceStartTime) >= FINAL_TIME_GUARD_MS;
                const shouldShowFinal = hasData && hasFinalTime && hasPlace && raceInProgress && pastGuard;

                // Explode or restore lane indicator brick
                if (!hasData) {
                    explodeLaneIndicator(laneNum);
                } else {
                    restoreLaneIndicator(laneNum);
                }

                // Pre-race lineup display (show when race not in progress, ignore stale final times)
                if (hasData && showLineup) {
                    lineupLane.textContent = laneData.LaneNumber;
                    lineupName.textContent = laneData.AthleteName;
                    lineupTeam.textContent = laneData.Team || '';
                    if (!lineupVisibility[laneCounter]) {
                        lineupContent.classList.remove('hiding');
                        lineupContent.classList.add('visible');
                        lineupVisibility[laneCounter] = true;
                    }
                } else {
                    if (lineupVisibility[laneCounter]) {
                        lineupContent.classList.remove('visible');
                        lineupContent.classList.add('hiding');
                        lineupVisibility[laneCounter] = false;
                        setTimeout(() => {
                            if (!lineupVisibility[laneCounter]) {
                                lineupLane.textContent = '';
                                lineupName.textContent = '';
                                lineupTeam.textContent = '';
                            }
                        }, 300);
                    }
                }

                if (shouldShowFinal) {
                    swimmerName.textContent = laneData.AthleteName;
                    finalTime.textContent = laneData.FinalTime;
                    laneContent.classList.remove('first-place', 'second-place', 'third-place');

                    if (laneData.Place && laneData.Place.trim() !== "" && laneData.Place.trim() !== " ") {
                        placeIndicator.textContent = getPlaceText(laneData.Place.trim());
                        const place = laneData.Place.trim();
                        if (place === "1") laneContent.classList.add('first-place');
                        else if (place === "2") laneContent.classList.add('second-place');
                        else if (place === "3") laneContent.classList.add('third-place');
                    } else {
                        placeIndicator.textContent = "";
                    }

                    if (!laneVisibility[laneCounter]) {
                        laneContent.classList.remove('hiding');
                        laneContent.classList.add('visible');
                        laneVisibility[laneCounter] = true;
                    }

                    if (splitVisibility[laneCounter]) {
                        if (splitTimeouts[laneCounter]) {
                            clearTimeout(splitTimeouts[laneCounter]);
                            splitTimeouts[laneCounter] = null;
                        }
                        lastSplitValue[laneCounter] = null;
                        splitContent.classList.remove('visible');
                        splitContent.classList.add('hiding');
                        splitVisibility[laneCounter] = false;
                        setTimeout(() => {
                            if (!splitVisibility[laneCounter]) splitTime.textContent = "";
                        }, 300);
                    }
                } else {
                    if (laneVisibility[laneCounter]) {
                        laneContent.classList.remove('visible');
                        laneContent.classList.add('hiding');
                        laneVisibility[laneCounter] = false;
                        setTimeout(() => {
                            if (!laneVisibility[laneCounter]) {
                                swimmerName.textContent = "";
                                finalTime.textContent = "";
                                placeIndicator.textContent = "";
                                laneContent.classList.remove('first-place', 'second-place', 'third-place');
                            }
                        }, 300);
                    }

                    if (hasData && hasSplitTime && raceInProgress) {
                        const isNewSplit = laneData.SplitTime !== lastSplitValue[laneCounter];
                        if (isNewSplit) {
                            lastSplitValue[laneCounter] = laneData.SplitTime;
                            splitTime.textContent = laneData.SplitTime;
                            if (splitTimeouts[laneCounter]) clearTimeout(splitTimeouts[laneCounter]);
                            if (!splitVisibility[laneCounter]) {
                                splitContent.classList.remove('hiding');
                                splitContent.classList.add('visible');
                                splitVisibility[laneCounter] = true;
                            }
                            const splitSeconds = parseFloat(laneData.SplitTime) || 5;
                            const displayDuration = splitSeconds * SPLIT_DISPLAY_PERCENT * 1000;
                            splitTimeouts[laneCounter] = setTimeout(() => {
                                splitContent.classList.remove('visible');
                                splitContent.classList.add('hiding');
                                splitVisibility[laneCounter] = false;
                                lastSplitValue[laneCounter] = null;
                                setTimeout(() => {
                                    if (!splitVisibility[laneCounter]) splitTime.textContent = "";
                                }, 300);
                            }, displayDuration);
                        }
                    }
                }
            }
        }

        function getPlaceText(place) {
            const num = parseInt(place);
            if (isNaN(num)) return place;
            const suffixes = ['th', 'st', 'nd', 'rd'];
            const v = num % 100;
            return num + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
        }
    </script>
</body>
</html>
