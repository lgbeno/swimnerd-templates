<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            height: 100vh;
            overflow: hidden;
        }

        .main-layout {
            display: flex;
            height: 100vh;
        }

        /* Left Panel - Controls */
        .controls-panel {
            width: 400px;
            flex-shrink: 0;
            overflow-y: auto;
            padding: 15px;
            background: #16213e;
            border-right: 2px solid #00d4ff;
        }

        .controls-panel h1 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #00d4ff;
            text-align: center;
        }

        /* Right Panel - Iframes */
        .preview-panel {
            flex: 1;
            display: none;
            flex-direction: column;
            background: #2d2d44;
            padding: 10px;
            gap: 10px;
        }

        .preview-panel.visible {
            display: flex;
        }

        .iframe-container {
            position: relative;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
        }

        .iframe-container.header {
            height: 100px;
            flex-shrink: 0;
        }

        .iframe-container.lanes {
            flex: 1;
            min-height: 300px;
        }

        .iframe-container.timer {
            height: 80px;
            flex-shrink: 0;
        }

        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .iframe-label {
            position: absolute;
            top: 5px;
            right: 10px;
            background: rgba(0, 212, 255, 0.8);
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            z-index: 10;
        }

        /* Control Styles */
        .status {
            text-align: center;
            padding: 8px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .status.connected {
            background: rgba(0, 255, 100, 0.2);
            color: #00ff64;
        }

        .status.disconnected {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6464;
        }

        .control-group {
            background: #0f0f23;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .control-group h3 {
            margin-bottom: 10px;
            color: #00d4ff;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-size: 0.75rem;
            color: #aaa;
        }

        input, select {
            width: 100%;
            padding: 6px;
            margin-bottom: 8px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #1a1a2e;
            color: #eee;
            font-size: 0.85rem;
        }

        button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        button:hover {
            transform: translateY(-1px);
        }

        .btn-primary { background: #00d4ff; color: #000; }
        .btn-success { background: #00ff64; color: #000; }
        .btn-warning { background: #ffaa00; color: #000; }
        .btn-danger { background: #ff4444; color: #fff; }

        .button-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .button-row button {
            flex: 1;
            min-width: 80px;
        }

        .lanes-editor h3 {
            margin-bottom: 10px;
            color: #00d4ff;
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .lane-row {
            display: grid;
            grid-template-columns: 30px 1fr 60px 70px 60px 40px;
            gap: 5px;
            margin-bottom: 6px;
            align-items: center;
        }

        .lane-row.header {
            font-weight: bold;
            color: #00d4ff;
            font-size: 0.65rem;
            border-bottom: 1px solid #333;
            padding-bottom: 6px;
            margin-bottom: 8px;
        }

        .lane-row input {
            margin-bottom: 0;
            padding: 4px;
            font-size: 0.75rem;
        }

        .lane-number {
            text-align: center;
            font-weight: bold;
            font-size: 0.9rem;
            color: #00d4ff;
        }

        .json-preview {
            background: #0f0f23;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.65rem;
            max-height: 120px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            color: #888;
        }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #0f0f23;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .toggle-label {
            font-size: 0.85rem;
            color: #eee;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: #888;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #00d4ff;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
            background-color: #fff;
        }

        #raceStatus {
            margin-top: 8px;
            color: #ffaa00;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- Left Panel - Controls -->
        <div class="controls-panel">
            <h1>Scoreboard Simulator</h1>

            <div class="status disconnected" id="status">
                Using BroadcastChannel
            </div>

            <div class="toggle-container">
                <span class="toggle-label">Show Preview</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="previewToggle" onchange="togglePreview()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="control-group">
                <h3>Event Info</h3>
                <label>Event Number</label>
                <input type="text" id="eventNumber" value="1">
                <label>Heat Number</label>
                <input type="text" id="heatNumber" value="1">
                <label>Event Name</label>
                <input type="text" id="eventName" value="100m Freestyle">
            </div>

            <div class="control-group">
                <h3>Timer</h3>
                <label>Running Time</label>
                <input type="text" id="runningTime" value=":  .">
                <div class="button-row">
                    <button class="btn-primary" onclick="startTimer()">Start</button>
                    <button class="btn-warning" onclick="stopTimer()">Stop</button>
                </div>
            </div>

            <div class="control-group">
                <h3>Quick Presets</h3>
                <div class="button-row">
                    <button class="btn-primary" onclick="loadPreset('empty')">Empty</button>
                    <button class="btn-success" onclick="loadPreset('fullRace')">Full Race</button>
                </div>
                <div class="button-row">
                    <button class="btn-warning" onclick="loadPreset('partial')">Partial</button>
                    <button class="btn-primary" onclick="loadPreset('randomize')">Randomize</button>
                </div>
            </div>

            <div class="control-group">
                <h3>Race Simulation</h3>
                <div class="button-row">
                    <button class="btn-success" onclick="startRaceSimulation()">Run Race</button>
                    <button class="btn-danger" onclick="stopRaceSimulation()">Stop</button>
                </div>
                <div id="raceStatus"></div>
            </div>

            <div class="control-group lanes-editor">
                <h3>Lane Data</h3>
                <div class="lane-row header">
                    <div>Ln</div>
                    <div>Athlete</div>
                    <div>Team</div>
                    <div>Final</div>
                    <div>Split</div>
                    <div>Pl</div>
                </div>
                <div id="lanesContainer"></div>
            </div>

            <div class="control-group">
                <h3>Actions</h3>
                <div class="button-row">
                    <button class="btn-success" onclick="sendData()">Send</button>
                    <button class="btn-primary" onclick="sendDataContinuous()">Auto</button>
                    <button class="btn-danger" onclick="stopContinuous()">Stop</button>
                </div>
                <div class="button-row">
                    <button class="btn-warning" onclick="clearAllTimes()">Clear Times</button>
                </div>
            </div>

            <div class="json-preview" id="jsonPreview">JSON preview...</div>
        </div>

        <!-- Right Panel - Preview Iframes -->
        <div class="preview-panel">
            <div class="iframe-container header">
                <span class="iframe-label">HEADER</span>
                <iframe id="headerFrame" src="HeaderOverlay.html"></iframe>
            </div>
            <div class="iframe-container lanes">
                <span class="iframe-label">LANES</span>
                <iframe id="lanesFrame" src="LaneOverlay.html"></iframe>
            </div>
            <div class="iframe-container timer">
                <span class="iframe-label">TIMER</span>
                <iframe id="timerFrame" src="TimerOverlay.html"></iframe>
            </div>
        </div>
    </div>

    <script>
        const NUM_LANES = 8;
        let timerInterval = null;
        let timerSeconds = 0;
        let continuousInterval = null;

        // BroadcastChannel for tab-to-tab communication
        const channel = new BroadcastChannel('swimnerd-scoreboard');

        // Also try WebSocket connection
        let wsClient = null;
        function connectWebSocket() {
            try {
                wsClient = new WebSocket("ws://localhost:8080/");
                wsClient.onopen = () => {
                    document.getElementById('status').textContent = 'Connected to WebSocket (port 8080)';
                    document.getElementById('status').className = 'status connected';
                };
                wsClient.onclose = () => {
                    document.getElementById('status').textContent = 'Using BroadcastChannel';
                    document.getElementById('status').className = 'status disconnected';
                    wsClient = null;
                };
                wsClient.onerror = () => {
                    wsClient = null;
                };
            } catch (e) {
                console.log('WebSocket not available, using BroadcastChannel only');
            }
        }
        connectWebSocket();

        // Sample swimmer names
        const sampleNames = [
            "Michael Phelps", "Katie Ledecky", "Caeleb Dressel", "Simone Manuel",
            "Ryan Lochte", "Missy Franklin", "Nathan Adrian", "Natalie Coughlin",
            "Adam Peaty", "Sarah Sjostrom", "Chad le Clos", "Penny Oleksiak"
        ];

        const sampleTeams = ["USA", "AUS", "GBR", "CAN", "GER", "SWE", "RSA", "JPN"];

        // Initialize lane editor
        function initLanes() {
            const container = document.getElementById('lanesContainer');
            container.innerHTML = '';

            for (let i = 1; i <= NUM_LANES; i++) {
                const row = document.createElement('div');
                row.className = 'lane-row';
                row.innerHTML = `
                    <div class="lane-number">${i}</div>
                    <input type="text" id="name-${i}" placeholder="Name">
                    <input type="text" id="team-${i}" placeholder="Team">
                    <input type="text" id="finalTime-${i}" placeholder="0:00.00">
                    <input type="text" id="splitTime-${i}" placeholder="." value=".">
                    <input type="text" id="place-${i}" placeholder=" " value=" ">
                `;
                container.appendChild(row);
            }
        }

        // Build JSON data from form
        function buildJsonData() {
            const lanes = [];
            for (let i = 1; i <= NUM_LANES; i++) {
                const name = document.getElementById(`name-${i}`).value;
                const hasData = name.trim() !== '';

                lanes.push({
                    LaneNumber: hasData ? String(i) : "",
                    AthleteName: name,
                    Team: document.getElementById(`team-${i}`).value,
                    Place: document.getElementById(`place-${i}`).value || " ",
                    SplitTime: document.getElementById(`splitTime-${i}`).value || ".",
                    FinalTime: document.getElementById(`finalTime-${i}`).value
                });
            }

            return {
                swimming: {
                    EventNumber: document.getElementById('eventNumber').value,
                    HeatNumber: document.getElementById('heatNumber').value,
                    EventName: document.getElementById('eventName').value,
                    RunningTime: document.getElementById('runningTime').value,
                    LaneAthleteTeam: lanes
                }
            };
        }

        // Send data to overlay
        function sendData() {
            const data = buildJsonData();
            const jsonStr = JSON.stringify(data, null, 2);
            document.getElementById('jsonPreview').textContent = jsonStr;

            // Send via BroadcastChannel
            channel.postMessage(data);

            // Also send via WebSocket if connected
            if (wsClient && wsClient.readyState === WebSocket.OPEN) {
                wsClient.send(JSON.stringify(data));
            }
        }

        let autoSending = false;
        function sendDataContinuous() {
            if (continuousInterval) return;
            autoSending = true;
            sendData();
            continuousInterval = setInterval(sendData, 1000);
        }

        function stopContinuous() {
            if (continuousInterval) {
                clearInterval(continuousInterval);
                continuousInterval = null;
            }
            autoSending = false;
        }

        // Timer functions
        function startTimer() {
            if (timerInterval) return;
            timerSeconds = 0;
            timerInterval = setInterval(() => {
                timerSeconds += 0.1;
                const mins = Math.floor(timerSeconds / 60);
                const secs = (timerSeconds % 60).toFixed(1);
                document.getElementById('runningTime').value = `${mins}:${secs.padStart(4, '0')}`;
                if (autoSending) sendData();
            }, 100);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('runningTime').value = ":  .";
        }

        // Presets
        function loadPreset(preset) {
            switch (preset) {
                case 'empty':
                    for (let i = 1; i <= NUM_LANES; i++) {
                        document.getElementById(`name-${i}`).value = '';
                        document.getElementById(`team-${i}`).value = '';
                        document.getElementById(`finalTime-${i}`).value = '';
                        document.getElementById(`splitTime-${i}`).value = '.';
                        document.getElementById(`place-${i}`).value = ' ';
                    }
                    break;

                case 'fullRace':
                    const times = generateRaceTimes();
                    const shuffledNames = [...sampleNames].sort(() => Math.random() - 0.5);
                    const shuffledTeams = [...sampleTeams].sort(() => Math.random() - 0.5);

                    for (let i = 1; i <= NUM_LANES; i++) {
                        document.getElementById(`name-${i}`).value = shuffledNames[i - 1] || `Swimmer ${i}`;
                        document.getElementById(`team-${i}`).value = shuffledTeams[(i - 1) % sampleTeams.length];
                        document.getElementById(`finalTime-${i}`).value = times[i - 1].time;
                        document.getElementById(`splitTime-${i}`).value = times[i - 1].split;
                        document.getElementById(`place-${i}`).value = times[i - 1].place;
                    }
                    break;

                case 'partial':
                    loadPreset('fullRace');
                    // Clear some lanes
                    for (let i = 5; i <= NUM_LANES; i++) {
                        document.getElementById(`finalTime-${i}`).value = '';
                        document.getElementById(`place-${i}`).value = ' ';
                    }
                    break;

                case 'randomize':
                    const newTimes = generateRaceTimes();
                    for (let i = 1; i <= NUM_LANES; i++) {
                        if (document.getElementById(`name-${i}`).value) {
                            document.getElementById(`finalTime-${i}`).value = newTimes[i - 1].time;
                            document.getElementById(`splitTime-${i}`).value = newTimes[i - 1].split;
                            document.getElementById(`place-${i}`).value = newTimes[i - 1].place;
                        }
                    }
                    break;
            }
            sendData();
        }

        function generateRaceTimes() {
            const basetime = 50 + Math.random() * 20; // 50-70 seconds
            const times = [];

            for (let i = 0; i < NUM_LANES; i++) {
                const variance = Math.random() * 8; // 0-8 seconds variance
                const totalSeconds = basetime + variance;
                const mins = Math.floor(totalSeconds / 60);
                const secs = (totalSeconds % 60).toFixed(2);
                const splitSeconds = totalSeconds * 0.48 + Math.random() * 2;
                const splitSecs = splitSeconds.toFixed(2);

                times.push({
                    time: `${mins}:${secs.padStart(5, '0')}`,
                    split: splitSecs,
                    totalSeconds: totalSeconds
                });
            }

            // Sort by time and assign places
            times.sort((a, b) => a.totalSeconds - b.totalSeconds);
            times.forEach((t, idx) => t.place = String(idx + 1));

            // Shuffle back to lane order but keep places
            const result = [];
            const shuffled = [...times].sort(() => Math.random() - 0.5);
            for (let i = 0; i < NUM_LANES; i++) {
                result.push(shuffled[i]);
            }

            return result;
        }

        function clearAllTimes() {
            for (let i = 1; i <= NUM_LANES; i++) {
                document.getElementById(`finalTime-${i}`).value = '';
                document.getElementById(`splitTime-${i}`).value = '.';
                document.getElementById(`place-${i}`).value = ' ';
            }
            sendData();
        }

        // Race Simulation
        let raceSimulationRunning = false;
        let raceTimeouts = [];
        let laneSplitTimes = [];
        let laneFinalTimes = [];

        function startRaceSimulation() {
            if (raceSimulationRunning) return;
            raceSimulationRunning = true;

            // Clear any existing timeouts
            raceTimeouts.forEach(t => clearTimeout(t));
            raceTimeouts = [];

            // Setup swimmers
            const shuffledNames = [...sampleNames].sort(() => Math.random() - 0.5);
            const shuffledTeams = [...sampleTeams].sort(() => Math.random() - 0.5);

            // Initialize lane data
            laneSplitTimes = [];
            laneFinalTimes = [];

            for (let i = 1; i <= NUM_LANES; i++) {
                document.getElementById(`name-${i}`).value = shuffledNames[i - 1] || `Swimmer ${i}`;
                document.getElementById(`team-${i}`).value = shuffledTeams[(i - 1) % sampleTeams.length];
                document.getElementById(`finalTime-${i}`).value = '';
                document.getElementById(`splitTime-${i}`).value = '.';
                document.getElementById(`place-${i}`).value = ' ';

                // Generate random lap times for this lane (1 split before final)
                const baseLapTime = 13 + Math.random() * 2;
                const splitDeltas = [];
                const splitCumulative = [];
                let cumulative = 0;

                // First half of race (split)
                const splitLap = baseLapTime + (Math.random() - 0.5) * 2;
                cumulative += splitLap;
                splitDeltas.push(splitLap);
                splitCumulative.push(cumulative);

                // Second half of race (to final)
                const finalLap = baseLapTime + 3 + Math.random() * 4;
                cumulative += finalLap;
                laneSplitTimes.push({ deltas: splitDeltas, cumulative: splitCumulative });
                laneFinalTimes.push(cumulative);
            }

            // Clear and start timer
            stopTimer();
            clearAllTimes();
            startTimer();
            sendDataContinuous();

            updateRaceStatus('Race started...');

            // Schedule splits for each lane
            for (let lane = 1; lane <= NUM_LANES; lane++) {
                const { deltas, cumulative } = laneSplitTimes[lane - 1];
                const finalTime = laneFinalTimes[lane - 1];

                // Single split
                const tSplit = setTimeout(() => {
                    if (!raceSimulationRunning) return;
                    document.getElementById(`splitTime-${lane}`).value = deltas[0].toFixed(2);
                    updateRaceStatus(`Split: Lane ${lane}`);
                }, cumulative[0] * 1000);
                raceTimeouts.push(tSplit);

                const tClear = setTimeout(() => {
                    if (!raceSimulationRunning) return;
                    document.getElementById(`splitTime-${lane}`).value = '.';
                }, (cumulative[0] + 1.5) * 1000);
                raceTimeouts.push(tClear);

                // Final time
                const tFinal = setTimeout(() => {
                    if (!raceSimulationRunning) return;
                    const mins = Math.floor(finalTime / 60);
                    const secs = (finalTime % 60).toFixed(2);
                    document.getElementById(`finalTime-${lane}`).value = `${mins}:${secs.padStart(5, '0')}`;
                    document.getElementById(`splitTime-${lane}`).value = '.';
                    updatePlaces();
                    updateRaceStatus(`Finish: Lane ${lane}`);
                }, finalTime * 1000);
                raceTimeouts.push(tFinal);
            }

            // End race
            const maxTime = Math.max(...laneFinalTimes);
            const tEnd = setTimeout(() => {
                if (!raceSimulationRunning) return;
                updateRaceStatus('Race complete!');
                stopTimer();
                raceSimulationRunning = false;
            }, (maxTime + 3) * 1000);
            raceTimeouts.push(tEnd);
        }

        function stopRaceSimulation() {
            raceSimulationRunning = false;
            raceTimeouts.forEach(t => clearTimeout(t));
            raceTimeouts = [];
            stopTimer();
            stopContinuous();
            updateRaceStatus('Stopped');
        }

        function updatePlaces() {
            const finishers = [];
            for (let i = 1; i <= NUM_LANES; i++) {
                const finalTimeStr = document.getElementById(`finalTime-${i}`).value;
                if (finalTimeStr && finalTimeStr.trim() !== '') {
                    const parts = finalTimeStr.split(':');
                    const mins = parseInt(parts[0]) || 0;
                    const secs = parseFloat(parts[1]) || 0;
                    const totalSecs = mins * 60 + secs;
                    finishers.push({ lane: i, time: totalSecs });
                }
            }

            finishers.sort((a, b) => a.time - b.time);
            finishers.forEach((f, idx) => {
                document.getElementById(`place-${f.lane}`).value = String(idx + 1);
            });
        }

        function updateRaceStatus(message) {
            document.getElementById('raceStatus').textContent = message;
        }

        // Toggle preview panel
        function togglePreview() {
            const previewPanel = document.querySelector('.preview-panel');
            const toggle = document.getElementById('previewToggle');
            if (toggle.checked) {
                previewPanel.classList.add('visible');
            } else {
                previewPanel.classList.remove('visible');
            }
        }

        // Initialize
        initLanes();
        loadPreset('fullRace');
    </script>
</body>
</html>
