<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer Overlay</title>

    <!-- THEME: Change this line to switch themes -->
    <link href="themes/mario-theme.css" rel="stylesheet">
    <!-- Alternative: <link href="themes/default-theme.css" rel="stylesheet"> -->

    <style>
        /* ==================== */
        /* STRUCTURAL CSS ONLY */
        /* (Layout, positioning) */
        /* ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: transparent;
            height: 100vh;
            overflow: hidden;
        }

        .timer-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            overflow: visible;
        }

        .timer-content {
            padding: 15px 30px 15px 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: scale(0);
            opacity: 0;
            position: relative;
        }

        .timer-label {
            margin-right: 15px;
            margin-left: 5px;
            text-transform: uppercase;
        }

        .running-time {
            font-variant-numeric: tabular-nums;
            letter-spacing: 2px;
        }

        /* Placeholder styling */
        .placeholder-content {
            padding: 15px 30px 15px 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            opacity: 0.6;
        }

        .placeholder-content.hidden {
            display: none;
        }

        .placeholder-text {
            text-transform: uppercase;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>
    <div class="timer-container">
        <!-- Placeholder shown until first data received -->
        <div class="placeholder-content timer-content visible" id="placeholder">
            <span class="placeholder-text">Waiting for data...</span>
        </div>

        <div class="timer-content" id="timerContent">
            <div class="clock-hand" id="clockHand"></div>
            <span class="timer-label">TIME</span>
            <span class="running-time" id="runningTime"></span>
        </div>
    </div>

    <script id="swimmingScript">
        let timerVisible = false;
        let firstMessageReceived = false;
        let lastTimeValue = '';
        let staleTimeout = null;
        let hiddenDueToStale = false;
        const STALE_TIMEOUT_MS = 5000; // Hide after 5 seconds of no change
        const RESET_THRESHOLD_SECONDS = 2; // Only reappear if time < 2 seconds

        const channel = new BroadcastChannel('swimnerd-scoreboard');
        channel.onmessage = function(e) {
            processTimerData(e.data);
        };

        let client = null;
        function connectWebSocket() {
            try {
                client = new WebSocket("ws://localhost:8080/");
                client.onerror = () => console.log('WebSocket Connection Error');
                client.onopen = () => console.log('WebSocket Client Connected');
                client.onclose = () => {
                    console.log('WebSocket Client Closed');
                    setTimeout(connectWebSocket, 3000);
                };
                client.onmessage = (e) => processTimerData(JSON.parse(e.data));
            } catch (e) {
                console.log('WebSocket not available');
            }
        }
        connectWebSocket();

        function processTimerData(jsonData) {
            // Hide placeholder on first message
            if (!firstMessageReceived) {
                firstMessageReceived = true;
                document.getElementById('placeholder').classList.add('hidden');
            }

            const timerContent = document.getElementById('timerContent');
            const runningTime = document.getElementById('runningTime');
            const clockHand = document.getElementById('clockHand');
            const time = jsonData.swimming.RunningTime;

            const isRunning = time &&
                time.trim() !== "" &&
                time.trim() !== ":  ." &&
                time.trim() !== ": 0.0" &&
                time.trim() !== "0.0";

            if (isRunning) {
                // Parse total seconds from time string (format: "M:SS.s" or "MM:SS.ss")
                let totalSeconds = 0;
                const parts = time.split(':');
                if (parts.length === 2) {
                    const mins = parseInt(parts[0]) || 0;
                    const secs = parseFloat(parts[1]) || 0;
                    totalSeconds = mins * 60 + secs;
                    // Set CSS variable for clock hand rotation (0-60 seconds = 0-360 degrees)
                    clockHand.style.setProperty('--seconds', secs % 60);
                }

                // Check if time value changed
                const timeChanged = time !== lastTimeValue;

                if (timeChanged) {
                    lastTimeValue = time;
                    runningTime.textContent = time;

                    // Clear any existing stale timeout
                    if (staleTimeout) {
                        clearTimeout(staleTimeout);
                        staleTimeout = null;
                    }

                    // Set new stale timeout - hide if no change for 5 seconds
                    staleTimeout = setTimeout(() => {
                        if (timerVisible) {
                            timerContent.classList.remove('visible');
                            timerContent.classList.add('hiding');
                            timerVisible = false;
                            hiddenDueToStale = true;
                            setTimeout(() => {
                                if (!timerVisible) runningTime.textContent = '';
                            }, 300);
                        }
                    }, STALE_TIMEOUT_MS);

                    // Show timer if: not visible AND (not hidden due to stale OR time is under threshold)
                    if (!timerVisible) {
                        if (!hiddenDueToStale || totalSeconds < RESET_THRESHOLD_SECONDS) {
                            timerContent.classList.remove('hiding');
                            timerContent.classList.add('visible');
                            timerVisible = true;
                            hiddenDueToStale = false;
                        }
                    }
                }
            } else {
                if (timerVisible) {
                    timerContent.classList.remove('visible');
                    timerContent.classList.add('hiding');
                    timerVisible = false;
                    setTimeout(() => {
                        if (!timerVisible) runningTime.textContent = '';
                    }, 300);
                }
            }
        }
    </script>
</body>
</html>
